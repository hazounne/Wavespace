#!/bin/bash

# Function to get the list of idle CPU cores
get_idle_cores() {
    idle_cores=""
    while read -r line; do
        core=$(echo "$line" | awk '{print $1}')
        usage=$(echo "$line" | awk '{print $NF}')
        if [ $(echo "$usage < 10" | bc) -eq 1 ]; then
            idle_cores+=" $core"
        fi
    done < <(mpstat -P ALL 1 1 | awk '/^[0-9]/ {print $3, $NF}')
    echo "$idle_cores"
}

# Function to set taskset with a maximum of 11 cores
set_taskset() {
    idle_cores=$(get_idle_cores)
    num_cores=$(echo $idle_cores | wc -w)
    if [ $num_cores -eq 0 ]; then
        echo "No idle CPU cores found."
        return
    fi

    # Limit to maximum of 11 cores
    if [ $num_cores -gt 11 ]; then
        idle_cores=$(echo $idle_cores | cut -d' ' -f1-11)
    fi

    taskset -c $idle_cores "$@"
}

# Usage: set_taskset command [arguments...]
set_taskset "$@"
